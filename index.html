<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2D –†–∏–±–∞–ª–∫–∞ –°–∏–º—É–ª—è—Ç–æ—Ä (–í–∏–ø—Ä–∞–≤–ª–µ–Ω–æ –±–∞–≥–∏)</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            margin: 0;
            overflow: hidden; 
            background-color: #333;
            font-family: 'Montserrat', Arial, sans-serif;
            touch-action: none; 
        }

        canvas {
            display: block;
            background-color: #4CAF50; 
        }

        /* --- UI –®–∞—Ä–∏ --- */
        #ui-layer {
            position: absolute;
            top: 10px;
            left: 10px;
            color: white;
            font-size: 20px;
            font-weight: bold;
            text-shadow: 1px 1px 2px black;
            pointer-events: none;
            z-index: 10;
        }

        #message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: yellow;
            font-size: 24px;
            font-weight: bold;
            text-shadow: 2px 2px 4px black;
            display: none;
            pointer-events: none;
            z-index: 10;
        }

        /* --- –ö–µ—Ä—É–≤–∞–Ω–Ω—è --- */
        #mobile-controls {
            position: absolute;
            bottom: 20px;
            width: 100%;
            height: 150px;
            display: flex;
            justify-content: space-between;
            padding: 0 20px;
            box-sizing: border-box;
            pointer-events: none;
            z-index: 10;
        }

        .joystick-area {
            width: 120px;
            height: 120px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            position: relative;
            pointer-events: auto; 
        }

        .joystick-stick {
            width: 50px;
            height: 50px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .action-btn {
            width: 100px;
            height: 100px;
            background: rgba(255, 0, 0, 0.5);
            border-radius: 50%;
            border: 2px solid white;
            color: white;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: auto; 
            user-select: none;
            font-family: 'Montserrat', Arial, sans-serif;
        }

        .action-btn:active {
            background: rgba(255, 255, 255, 0.3);
        }
    </style>
</head>
<body>

    <div id="ui-layer">
        <div>üêü –†–∏–±–∞: <span id="fish-count">0</span></div>
        <div>üí∞ –ì—Ä–æ—à—ñ: <span id="money-count">0</span></div>
        <div style="margin-top: 10px;">‚è∞ –ß–∞—Å: <span id="time-display">06:00</span></div>
    </div>

    <div id="message"></div>

    <div id="mobile-controls">
        <div class="joystick-area" id="joystick">
            <div class="joystick-stick" id="stick"></div>
        </div>
        <div class="action-btn" id="action-btn">–î–Ü–Ø</div>
    </div>

    <canvas id="gameCanvas"></canvas>

<script>
    // --- –ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø –ì–†–ò ---
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    
    // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è —Ä–æ–∑–º—ñ—Ä—ñ–≤
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    let currentScene = 'shore'; 

    // --- –û–ë'–Ñ–ö–¢ –ß–ê–°–£ ---
    const time = {
        gameHour: 6, // –ü–æ—á–∏–Ω–∞—î–º–æ –æ 6:00
        gameMinute: 0,
        timeScale: 0.1, // –ß–∏–º –º–µ–Ω—à–µ, —Ç–∏–º –ø–æ–≤—ñ–ª—å–Ω—ñ—à–µ –π–¥–µ —á–∞—Å (0.1 = 1 –≥–æ–¥–∏–Ω–∞ ~ 6 —Å–µ–∫—É–Ω–¥ —Ä–µ–∞–ª—å–Ω–æ–≥–æ —á–∞—Å—É)
        lastTime: 0,
    };
    
    const player = {
        x: canvas.width / 2,
        y: canvas.height / 2,
        size: 60, 
        speed: 4,
        fish: 0,
        money: 0,
        isFishing: false,
        rodLevel: 1 
    };

    // –û–±'—î–∫—Ç–∏ –∞–ø–≥—Ä–µ–π–¥—ñ–≤
    const upgrades = {
        rod: {
            level: 2, cost: 50, timeReduction: 1000, description: "–ö—Ä–∞—â–∞ –≤—É–¥–∫–∞: -1 —Å–µ–∫. –Ω–∞ —Ä–∏–±–æ–ª–æ–≤–ª—é."
        }
    };

    // –†–æ–∑–º—ñ—Ä–∏ –∑–æ–Ω
    const ZONE_WIDTH_PERCENT = 0.20; 
    let zoneWidth = canvas.width * ZONE_WIDTH_PERCENT;

    // –ó–æ–Ω–∏ –ë–µ—Ä–µ–≥–∞
    const waterZone = { x: 0, y: 0, w: zoneWidth, h: canvas.height, color: '#2196F3' }; 
    const shopEntranceZone = { x: canvas.width - zoneWidth, y: 0, w: zoneWidth, h: canvas.height, color: '#795548' }; 
    const homeEntranceZone = { x: 250, y: 100, w: 200, h: 200, color: '#5C3317' }; // –ü–µ—Ä–µ–º—ñ—Å—Ç–∏–≤ –±—É–¥–∏–Ω–æ–∫, —â–æ–± –Ω–µ –∑–∞–≤–∞–∂–∞–≤ –º–∞–≥–∞–∑–∏–Ω—É

    // –ó–æ–Ω–∏ –ú–∞–≥–∞–∑–∏–Ω—É
    const shopInterior = { 
        color: '#3A3A3A', 
        exitY: canvas.height - 50, 
    };

    const sellCrates = {
        x: canvas.width / 2 - 100, 
        y: canvas.height / 3, 
        size: 80,
        color: '#B5651D' 
    };

    const upgradeStand = {
        x: canvas.width / 2 + 100, 
        y: canvas.height / 3, 
        size: 80,
        color: '#444444' 
    };

    // –ó–æ–Ω–∏ –ë—É–¥–∏–Ω–∫—É
    const homeInterior = {
        color: '#8B4513', 
        exitY: canvas.height - 50,
        bed: { x: 100, y: 100, w: 100, h: 50, color: '#800000' } // –õ—ñ–∂–∫–æ
    }


    const FISHING_RANGE = player.size * 0.75; 
    const INTERACT_RANGE = player.size * 1.5; 

    // –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ 
    const playerImage = new Image();
    playerImage.src = 'Buzz_fisherman.png'; 
    let playerImageLoaded = false;
    let gameReady = false;

    playerImage.onload = () => {
        playerImageLoaded = true;
        gameReady = true;
        gameLoop(0); 
    };

    playerImage.onerror = () => {
        console.error("–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è 'Buzz_fisherman.png'.");
        playerImageLoaded = false; 
        gameReady = true;
        gameLoop(0); 
    };
    
    // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Ä–æ–∑–º—ñ—Ä—ñ–≤ –∑–æ–Ω –ø—Ä–∏ —Ä–µ—Å–∞–π–∑—ñ
    function updateZoneDimensions() {
        zoneWidth = canvas.width * ZONE_WIDTH_PERCENT;
        waterZone.w = zoneWidth;
        shopEntranceZone.x = canvas.width - zoneWidth;
        shopEntranceZone.w = zoneWidth;
        waterZone.h = canvas.height;
        shopEntranceZone.h = canvas.height;

        // –ü–æ–∑–∏—Ü—ñ—ó —É —Å—Ü–µ–Ω–∞—Ö
        shopInterior.exitY = canvas.height - 50;
        sellCrates.x = canvas.width / 2 - 100;
        sellCrates.y = canvas.height / 3;
        upgradeStand.x = canvas.width / 2 + 100;
        upgradeStand.y = canvas.height / 3;
        homeInterior.exitY = canvas.height - 50;
    }

    // --- –õ–û–ì–Ü–ö–ê –ß–ê–°–£ (–í–ò–ü–†–ê–í–õ–ï–ù–û) ---

    function updateTime(deltaTimeSeconds) {
        // –í–ò–ü–†–ê–í–õ–ï–ù–ù–Ø: deltaTimeSeconds —Ç–µ–ø–µ—Ä –∫–æ—Ä–µ–∫—Ç–Ω–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è
        time.gameMinute += deltaTimeSeconds * 60 * time.timeScale;

        // –Ø–∫—â–æ —Ö–≤–∏–ª–∏–Ω–∞ –ø–µ—Ä–µ–≤–∏—â—É—î 60
        while (time.gameMinute >= 60) {
            time.gameMinute -= 60;
            time.gameHour++;
        }

        // –Ø–∫—â–æ –≥–æ–¥–∏–Ω–∞ –ø–µ—Ä–µ–≤–∏—â—É—î 23 (–ø–µ—Ä–µ—Ö—ñ–¥ –¥–æ –Ω–æ–≤–æ–≥–æ –¥–Ω—è)
        while (time.gameHour >= 24) {
            time.gameHour -= 24;
        }

        // –û–Ω–æ–≤–ª–µ–Ω–Ω—è UI
        const hourDisplay = String(time.gameHour).padStart(2, '0');
        const minuteDisplay = String(Math.floor(time.gameMinute)).padStart(2, '0');
        document.getElementById('time-display').innerText = `${hourDisplay}:${minuteDisplay}`;
    }

    function getOverlayColor() {
        const hour = time.gameHour + time.gameMinute / 60;
        let opacity = 0;

        // –õ–æ–≥—ñ–∫–∞ –¥–Ω—è/–Ω–æ—á—ñ (–±–µ–∑ –∑–º—ñ–Ω)
        if (hour >= 20 && hour <= 24) { 
            opacity = (hour - 20) / 4 * 0.6; 
        } else if (hour >= 0 && hour <= 4) { 
            opacity = 0.6; 
        } else if (hour > 4 && hour < 6) { 
            opacity = 0.6 - (hour - 4) / 2 * 0.6; 
        } else {
            opacity = 0; 
        }
        return `rgba(0, 0, 0, ${Math.min(opacity, 0.6).toFixed(3)})`;
    }

    // --- –ö–ï–†–£–í–ê–ù–ù–Ø –¢–ê –î–ñ–û–ô–°–¢–ò–ö (–ë–µ–∑ –∑–º—ñ–Ω) ---
    const keys = { w: false, a: false, s: false, d: false };
    
    window.addEventListener('keydown', (e) => {
        if(e.key === 'w' || e.key === 'W') keys.w = true;
        if(e.key === 'a' || e.key === 'A') keys.a = true;
        if(e.key === 's' || e.key === 'S') keys.s = true;
        if(e.key === 'd' || e.key === 'D') keys.d = true;
        if(e.key === ' ') handleAction(); 
    });

    window.addEventListener('keyup', (e) => {
        if(e.key === 'w' || e.key === 'W') keys.w = false;
        if(e.key === 'a' || e.key === 'A') keys.a = false;
        if(e.key === 's' || e.key === 'S') keys.s = false;
        if(e.key === 'd' || e.key === 'D') keys.d = false;
    });

    const joystick = document.getElementById('joystick');
    const stick = document.getElementById('stick');
    let touchId = null;
    let joyInput = { x: 0, y: 0 }; 
    let isDragging = false;

    function resetJoystick() {
        stick.style.transform = `translate(-50%, -50%)`;
        joyInput = { x: 0, y: 0 };
        isDragging = false;
        touchId = null;
    }

    function updateJoystick(input) {
        const clientX = input.clientX || input.pageX;
        const clientY = input.clientY || input.pageY;
        const rect = joystick.getBoundingClientRect();
        const centerX = rect.left + rect.width / 2;
        const centerY = rect.top + rect.height / 2;
        let dx = clientX - centerX;
        let dy = clientY - centerY;
        const distance = Math.min(Math.sqrt(dx*dx + dy*dy), rect.width/2);
        const angle = Math.atan2(dy, dx);
        const moveX = Math.cos(angle) * distance;
        const moveY = Math.sin(angle) * distance;
        stick.style.transform = `translate(calc(-50% + ${moveX}px), calc(-50% + ${moveY}px))`;
        joyInput.x = moveX / (rect.width/2);
        joyInput.y = moveY / (rect.height/2);
    }
    
    joystick.addEventListener('mousedown', (e) => { e.preventDefault(); isDragging = true; updateJoystick(e); });
    joystick.addEventListener('touchstart', (e) => { e.preventDefault(); const touch = e.changedTouches[0]; touchId = touch.identifier; isDragging = true; updateJoystick(touch); });
    window.addEventListener('mousemove', (e) => { if (isDragging && touchId === null) updateJoystick(e); });
    window.addEventListener('touchmove', (e) => { for (let i = 0; i < e.changedTouches.length; i++) { if (e.changedTouches[i].identifier === touchId) { updateJoystick(e.changedTouches[i]); break; } } });
    window.addEventListener('mouseup', (e) => { if (isDragging && touchId === null) resetJoystick(); });
    window.addEventListener('touchend', (e) => { for (let i = 0; i < e.changedTouches.length; i++) { if (e.changedTouches[i].identifier === touchId) { resetJoystick(); break; } } });

    document.getElementById('action-btn').addEventListener('touchstart', (e) => { e.preventDefault(); handleAction(); });
    document.getElementById('action-btn').addEventListener('mousedown', (e) => { e.preventDefault(); handleAction(); });

    // --- –õ–û–ì–Ü–ö–ê –°–¶–ï–ù ---
    
    function showMessage(text, duration = 1500) {
        const msg = document.getElementById('message');
        msg.innerText = text;
        msg.style.display = 'block';
        setTimeout(() => msg.style.display = 'none', duration);
    }

    function enterShop() {
        currentScene = 'shop';
        player.x = canvas.width / 2; 
        player.y = shopInterior.exitY - player.size;
        showMessage("–õ–∞—Å–∫–∞–≤–æ –ø—Ä–æ—Å–∏–º–æ –¥–æ –º–∞–≥–∞–∑–∏–Ω—É!", 1500);
    }

    function exitShop() {
        currentScene = 'shore';
        player.x = shopEntranceZone.x - player.size / 2;
        player.y = canvas.height / 2;
        showMessage("–í–∏ –≤–∏–π—à–ª–∏ –Ω–∞ –±–µ—Ä–µ–≥", 1500);
    }
    
    function enterHome() {
        currentScene = 'home';
        player.x = canvas.width / 2; 
        player.y = homeInterior.exitY - player.size;
        showMessage("–í–∏ —É —Å–≤–æ—î–º—É –∑–∞—Ç–∏—à–Ω–æ–º—É –¥–æ–º—ñ", 1500);
    }

    function exitHome() {
        currentScene = 'shore';
        // –í–ò–ü–†–ê–í–õ–ï–ù–ù–Ø: –¢–µ–ª–µ–ø–æ—Ä—Ç—É—î–º–æ –≥—Ä–∞–≤—Ü—è –¥–æ –¥–≤–µ—Ä–µ–π –±—É–¥–∏–Ω–∫—É
        player.x = homeEntranceZone.x + homeEntranceZone.w / 2; 
        player.y = homeEntranceZone.y + homeEntranceZone.h + player.size / 2;
        showMessage("–í–∏ –ø–æ–≤–µ—Ä–Ω—É–ª–∏—Å—è –Ω–∞ –±–µ—Ä–µ–≥", 1500);
    }

    function sleepNight() {
        if (time.gameHour < 20 && time.gameHour > 6) {
             showMessage("‚ùå –©–µ –Ω–µ —á–∞—Å —Å–ø–∞—Ç–∏. –ü–æ—Ç—Ä—ñ–±–Ω–æ –¥–æ—á–µ–∫–∞—Ç–∏—Å—è –Ω–æ—á—ñ (–ø—ñ—Å–ª—è 20:00).", 3000);
             return;
        }

        showMessage("üò¥ –í–∏ —Å–ø–∏—Ç–µ...", 3000);

        // –ü–µ—Ä–µ–º–æ—Ç—É–≤–∞–Ω–Ω—è —á–∞—Å—É –¥–æ 6:00 –Ω–∞—Å—Ç—É–ø–Ω–æ–≥–æ –¥–Ω—è
        setTimeout(() => {
            time.gameHour = 6;
            time.gameMinute = 0;
            showMessage("‚òÄÔ∏è –î–æ–±—Ä–æ–≥–æ —Ä–∞–Ω–∫—É! –í–∏ –ø—Ä–æ–∫–∏–Ω—É–ª–∏—Å—è.", 3000);
        }, 1000); 
    }

    function sellFish() {
        if (player.fish > 0) {
            let earnings = player.fish * 10;
            player.money += earnings;
            player.fish = 0;
            
            document.getElementById('fish-count').innerText = player.fish;
            document.getElementById('money-count').innerText = player.money;
            
            showMessage(`üí∞ –ü—Ä–æ–¥–∞–Ω–æ! +${earnings} –º–æ–Ω–µ—Ç`, 2000);
        } else {
            showMessage("‚ùå –£ —è—â–∏–∫—É –Ω–µ–º–∞—î —Ä–∏–±–∏ –¥–ª—è –ø—Ä–æ–¥–∞–∂—É", 2000);
        }
    }

    function buyUpgrade() {
        const upgrade = upgrades.rod;

        if (player.rodLevel >= upgrade.level) {
            showMessage("–£ –≤–∞—Å –≤–∂–µ –Ω–∞–π–∫—Ä–∞—â–∞ –≤—É–¥–∫–∞!", 2000);
            return;
        }
        
        if (player.money >= upgrade.cost) {
            player.money -= upgrade.cost;
            player.rodLevel = upgrade.level;
            document.getElementById('money-count').innerText = player.money;
            showMessage(`‚úÖ –ö—É–ø–ª–µ–Ω–æ: ${upgrade.description}`, 3000);
        } else {
            showMessage(`‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –≥—Ä–æ—à–µ–π! –ü–æ—Ç—Ä—ñ–±–Ω–æ ${upgrade.cost} –º–æ–Ω–µ—Ç.`, 2000);
        }
    }


    function handleAction() {
        if (player.isFishing) return; 

        if (currentScene === 'shore') {
            const fishingSpotX = waterZone.w + player.size / 2; 
            const distanceToFishingSpot = Math.abs(player.x - fishingSpotX);

            const shopEntranceX = shopEntranceZone.x - player.size / 2;
            const distanceToShop = Math.abs(player.x - shopEntranceX);
            
            const homeEntranceX = homeEntranceZone.x + homeEntranceZone.w / 2;
            const distanceToHome = Math.sqrt(
                Math.pow(player.x - homeEntranceX, 2) + 
                Math.pow(player.y - (homeEntranceZone.y + homeEntranceZone.h), 2)
            );

            // 1. –†–∏–±–æ–ª–æ–≤–ª—è
            if (distanceToFishingSpot < FISHING_RANGE) {
                catchFish();
            } 
            // 2. –í—Ö—ñ–¥ –¥–æ –º–∞–≥–∞–∑–∏–Ω—É
            else if (distanceToShop < INTERACT_RANGE) {
                enterShop();
            } 
            // 3. –í—Ö—ñ–¥ –¥–æ –±—É–¥–∏–Ω–∫—É
            else if (distanceToHome < INTERACT_RANGE * 1.5) {
                enterHome();
            }
            else {
                showMessage("–ü—ñ–¥—ñ–π–¥–∏ –¥–æ –≤–æ–¥–∏, –º–∞–≥–∞–∑–∏–Ω—É –∞–±–æ –¥–æ–º—É!");
            }
        } 
        else if (currentScene === 'shop') {
            const distToCrate = Math.sqrt(
                Math.pow(player.x - sellCrates.x, 2) + 
                Math.pow(player.y - sellCrates.y, 2)
            );

            const distToStand = Math.sqrt(
                Math.pow(player.x - upgradeStand.x, 2) + 
                Math.pow(player.y - upgradeStand.y, 2)
            );

            if (distToCrate < INTERACT_RANGE) {
                sellFish();
            } else if (distToStand < INTERACT_RANGE) {
                buyUpgrade();
            }
             else {
                showMessage("–ü—ñ–¥—ñ–π–¥–∏ –¥–æ —è—â–∏–∫—ñ–≤ (–ü—Ä–æ–¥–∞—Ç–∏) –∞–±–æ —Å—Ç—ñ–π–∫–∏ (–ö—É–ø–∏—Ç–∏)!");
            }
        }
        else if (currentScene === 'home') {
            const distToBed = Math.sqrt(
                Math.pow(player.x - homeInterior.bed.x, 2) + 
                Math.pow(player.y - homeInterior.bed.y, 2)
            );

            if (distToBed < INTERACT_RANGE * 2) {
                sleepNight();
            } else {
                showMessage("–ü—ñ–¥—ñ–π–¥–∏ –¥–æ –ª—ñ–∂–∫–∞, —â–æ–± –ø–µ—Ä–µ—Å–ø–∞—Ç–∏ –Ω—ñ—á.");
            }
        }
    }

    function catchFish() {
        player.isFishing = true; 
        
        let fishingTime = 4000; 
        if (player.rodLevel > 1) {
            fishingTime -= upgrades.rod.timeReduction; 
        }
        
        showMessage("üé£ –í—É–¥–∫–∞ –∑–∞–∫–∏–Ω—É—Ç–∞...");

        setTimeout(() => {
            player.fish++;
            document.getElementById('fish-count').innerText = player.fish;
            showMessage("‚úÖ –°–ø—ñ–π–º–∞–≤ —Ä–∏–±—É!", 1500);
            player.isFishing = false; 
        }, fishingTime); 
    }

    function update(deltaTimeSeconds) {
        // –û–Ω–æ–≤–ª–µ–Ω–Ω—è —á–∞—Å—É –≤—ñ–¥–±—É–≤–∞—î—Ç—å—Å—è –Ω–µ–∑–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ —Ä—É—Ö—É
        updateTime(deltaTimeSeconds);

        if (player.isFishing) return; 

        let dx = 0;
        let dy = 0;

        if (keys.w) dy -= player.speed;
        if (keys.s) dy += player.speed;
        if (keys.a) dx -= player.speed;
        if (keys.d) dx += player.speed;
        
        dx += joyInput.x * player.speed;
        dy += joyInput.y * player.speed;
        
        let newX = player.x + dx;
        let newY = player.y + dy;
        
        // --- –õ–û–ì–Ü–ö–ê –†–£–•–£ –¢–ê –ö–û–õ–Ü–ó–Ü–ô (–í–ò–ü–†–ê–í–õ–ï–ù–û) ---

        if (currentScene === 'shore') {
            // ... (–ö–æ–ª—ñ–∑—ñ—ó –±–µ—Ä–µ–≥–∞ –±–µ–∑ –∑–º—ñ–Ω) ...
            if (newX - player.size / 2 < waterZone.w) {
                newX = waterZone.w + player.size / 2; 
            }
            if (newX + player.size / 2 > shopEntranceZone.x) {
                 newX = shopEntranceZone.x - player.size / 2;
            }

        } else if (currentScene === 'shop') {
             // –í–∏—Ö—ñ–¥ –∑ –º–∞–≥–∞–∑–∏–Ω—É
            if (newY > shopInterior.exitY) {
                 exitShop();
                 return; 
            }
             // –û–±–º–µ–∂–µ–Ω–Ω—è –Ω–∞ —Ä—É—Ö (—â–æ–± –Ω–µ –≤–∏—Ö–æ–¥–∏–≤ –∑–∞ –º–µ–∂—ñ —Å—Ü–µ–Ω–∏)
            if (newY > shopInterior.exitY - player.size/2) newY = shopInterior.exitY - player.size/2;

        } else if (currentScene === 'home') {
             // –í–ò–ü–†–ê–í–õ–ï–ù–ù–Ø: –í–∏—Ö—ñ–¥ –∑ –¥–æ–º—É
            if (newY > homeInterior.exitY - player.size/2) {
                 // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ –≥—Ä–∞–≤–µ—Ü—å –ø–µ—Ä–µ—Ç–Ω—É–≤ –º–µ–∂—É –≤–∏—Ö–æ–¥—É
                 if (newY > homeInterior.exitY) {
                    exitHome();
                    return;
                 }
                 newY = homeInterior.exitY - player.size/2;
            }
             // –û–±–º–µ–∂–µ–Ω–Ω—è –Ω–∞ —Ä—É—Ö (—â–æ–± –Ω–µ –≤–∏—Ö–æ–¥–∏–≤ –∑–∞ –º–µ–∂—ñ —Å—Ü–µ–Ω–∏)
            if (newY < player.size / 2) newY = player.size / 2; // –í–µ—Ä—Ö–Ω—è —Å—Ç—ñ–Ω–∞
            // –û–±–º–µ–∂–µ–Ω–Ω—è –Ω–∞ —Ä—É—Ö (—â–æ–± –Ω–µ –≤–∏—Ö–æ–¥–∏–≤ –∑–∞ –º–µ–∂—ñ —Å—Ü–µ–Ω–∏)
            if (newX < player.size / 2) newX = player.size / 2; 
            if (newX > canvas.width - player.size / 2) newX = canvas.width - player.size / 2;
        }
        
        // –û–±–º–µ–∂–µ–Ω–Ω—è –µ–∫—Ä–∞–Ω—É (–∑–∞–≥–∞–ª—å–Ω–µ)
        if (newX < player.size / 2) newX = player.size / 2; 
        if (newX > canvas.width - player.size / 2) newX = canvas.width - player.size / 2;
        if (newY < player.size / 2) newY = player.size / 2;
        if (newY > canvas.height - player.size / 2) newY = canvas.height - player.size / 2;

        player.x = newX;
        player.y = newY;
    }

    function drawScene() {
        if (currentScene === 'shore') {
            // –ú–∞–ª—é—î–º–æ –ë–µ—Ä–µ–≥
            canvas.style.backgroundColor = '#4CAF50'; 
            
            ctx.fillStyle = waterZone.color;
            ctx.fillRect(waterZone.x, waterZone.y, waterZone.w, waterZone.h);
            ctx.fillStyle = "white";
            ctx.font = "20px 'Montserrat'";
            ctx.fillText("–†–Ü–ß–ö–ê", 20, canvas.height/2);

            ctx.fillStyle = shopEntranceZone.color;
            ctx.fillRect(shopEntranceZone.x, shopEntranceZone.y, shopEntranceZone.w, shopEntranceZone.h);
            ctx.fillStyle = "white";
            ctx.fillText("–ú–ê–ì–ê–ó–ò–ù", shopEntranceZone.x + 20, canvas.height/2);
            ctx.fillStyle = 'black'; // –î–≤–µ—Ä—ñ
            ctx.fillRect(shopEntranceZone.x + shopEntranceZone.w / 2 - 20, canvas.height / 2 + 50, 40, 60);

            // –ë—É–¥–∏–Ω–æ–∫
            ctx.fillStyle = homeEntranceZone.color;
            ctx.fillRect(homeEntranceZone.x, homeEntranceZone.y, homeEntranceZone.w, homeEntranceZone.h);
            ctx.fillStyle = "white";
            ctx.fillText("–î–Ü–ú", homeEntranceZone.x + 80, homeEntranceZone.y + 40);
            ctx.fillStyle = 'black'; // –î–≤–µ—Ä—ñ
            ctx.fillRect(homeEntranceZone.x + homeEntranceZone.w / 2 - 20, homeEntranceZone.y + homeEntranceZone.h - 10, 40, 60);


        } else if (currentScene === 'shop') {
            // –ú–∞–ª—é—î–º–æ –Ü–Ω—Ç–µ—Ä'—î—Ä –ú–∞–≥–∞–∑–∏–Ω—É
            canvas.style.backgroundColor = shopInterior.color; 
            
            ctx.fillStyle = '#1A1A1A';
            ctx.fillRect(0, shopInterior.exitY, canvas.width, canvas.height - shopInterior.exitY);
            ctx.fillStyle = "white";
            ctx.fillText("–í–ò–•–Ü–î", canvas.width / 2 - 30, shopInterior.exitY + 30);
            
            ctx.fillStyle = sellCrates.color;
            ctx.fillRect(sellCrates.x - sellCrates.size / 2, sellCrates.y - sellCrates.size / 2, sellCrates.size, sellCrates.size);
            ctx.fillStyle = 'yellow';
            ctx.fillText("–ü–†–û–î–ê–¢–ò", sellCrates.x - 35, sellCrates.y + sellCrates.size / 2 + 20);
            ctx.fillText(`–†–∏–±–∞: ${player.fish}`, sellCrates.x - 35, sellCrates.y + sellCrates.size / 2 + 40);

            ctx.fillStyle = upgradeStand.color;
            ctx.fillRect(upgradeStand.x - upgradeStand.size / 2, upgradeStand.y - upgradeStand.size / 2, upgradeStand.size, upgradeStand.size);
            ctx.fillStyle = '#00bcd4';
            ctx.fillText("–í–£–î–ö–ê", upgradeStand.x - 30, upgradeStand.y + sellCrates.size / 2 + 20);
            
            const upgradeStatus = player.rodLevel === upgrades.rod.level ? 'MAX' : `50$`;
            ctx.fillText(`–†—ñ–≤–µ–Ω—å ${player.rodLevel} / 2 (${upgradeStatus})`, upgradeStand.x - 50, upgradeStand.y + sellCrates.size / 2 + 40);

        } else if (currentScene === 'home') {
            // –í–ò–ü–†–ê–í–õ–ï–ù–ù–Ø: –ú–∞–ª—é—î–º–æ –Ü–Ω—Ç–µ—Ä'—î—Ä –î–æ–º—É
            canvas.style.backgroundColor = homeInterior.color;

            // –õ—ñ–∂–∫–æ
            ctx.fillStyle = homeInterior.bed.color;
            ctx.fillRect(homeInterior.bed.x, homeInterior.bed.y, homeInterior.bed.w, homeInterior.bed.h);
            ctx.fillStyle = 'white';
            ctx.fillText("–õ–Ü–ñ–ö–û", homeInterior.bed.x + 20, homeInterior.bed.y - 10);

            // –ó–æ–Ω–∞ –í–∏—Ö–æ–¥—É
            ctx.fillStyle = '#1A1A1A';
            ctx.fillRect(0, homeInterior.exitY, canvas.width, canvas.height - homeInterior.exitY);
            ctx.fillStyle = "white";
            ctx.fillText("–í–ò–•–Ü–î", canvas.width / 2 - 30, homeInterior.exitY + 30);
        }
    }

    function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        drawScene();

        // 1. –ú–∞–ª—é—î–º–æ –ì—Ä–∞–≤—Ü—è
        if (playerImageLoaded) {
            ctx.drawImage(playerImage, player.x - player.size / 2, player.y - player.size / 2, player.size, player.size);
        } else {
            ctx.beginPath();
            ctx.arc(player.x, player.y, player.size / 2, 0, Math.PI * 2);
            ctx.fillStyle = 'gray'; 
            ctx.fill();
            ctx.strokeStyle = "black";
            ctx.stroke();
        }

        // 2. –ú–∞–ª—é—î–º–æ –≤—É–¥–∫—É (–ª–∏—à–µ –Ω–∞ –±–µ—Ä–µ–∑—ñ)
        if (player.isFishing && currentScene === 'shore') {
            ctx.beginPath();
            ctx.moveTo(player.x, player.y - player.size / 4); 
            ctx.lineTo(waterZone.w / 2, canvas.height / 2); 
            ctx.strokeStyle = "gray";
            ctx.lineWidth = 2;
            ctx.stroke();
            ctx.beginPath();
            ctx.arc(waterZone.w / 2, canvas.height / 2, 5, 0, Math.PI * 2);
            ctx.fillStyle = "red";
            ctx.fill();
            ctx.strokeStyle = "black";
            ctx.lineWidth = 1;
            ctx.stroke();
        }

        // 3. –ù–∞–∫–ª–∞–¥–∞—î–º–æ –µ—Ñ–µ–∫—Ç –î–ù–Ø/–ù–û–ß–Ü –ø–æ–≤–µ—Ä—Ö —É—Å—å–æ–≥–æ
        ctx.fillStyle = getOverlayColor();
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // 4. –ü—ñ–¥–∫–∞–∑–∫–∏ 
        ctx.fillStyle = "black";
        ctx.font = "bold 14px 'Montserrat'";

        const INTERACT_RANGE_HELP = INTERACT_RANGE * 1.5;

        if (!player.isFishing) { 
            if (currentScene === 'shore') {
                const fishingSpotX = waterZone.w + player.size / 2; 
                const distToFishing = Math.abs(player.x - fishingSpotX);

                const shopEntranceX = shopEntranceZone.x - player.size / 2;
                const distToShop = Math.abs(player.x - shopEntranceX);
                
                const homeEntranceX = homeEntranceZone.x + homeEntranceZone.w / 2;
                const distToHome = Math.sqrt(
                    Math.pow(player.x - homeEntranceX, 2) + 
                    Math.pow(player.y - (homeEntranceZone.y + homeEntranceZone.h), 2)
                );

                if (distToFishing < INTERACT_RANGE_HELP) {
                    ctx.fillText("–¢–∏—Å–Ω–∏ –î–Ü–Æ (–õ–æ–≤–∏—Ç–∏)", player.x + player.size / 2 + 5, player.y);
                } 
                else if (distToShop < INTERACT_RANGE_HELP) {
                    ctx.fillText("–¢–∏—Å–Ω–∏ –î–Ü–Æ (–ú–∞–≥–∞–∑–∏–Ω)", player.x - player.size / 2 - 80, player.y);
                }
                 else if (distToHome < INTERACT_RANGE_HELP * 1.5) {
                    ctx.fillText("–¢–∏—Å–Ω–∏ –î–Ü–Æ (–î—ñ–º)", homeEntranceX - 40, homeEntranceZone.y + homeEntranceZone.h + 80);
                }
            } else if (currentScene === 'shop') {
                const distToCrate = Math.sqrt(
                    Math.pow(player.x - sellCrates.x, 2) + 
                    Math.pow(player.y - sellCrates.y, 2)
                );
                const distToStand = Math.sqrt(
                    Math.pow(player.x - upgradeStand.x, 2) + 
                    Math.pow(player.y - upgradeStand.y, 2)
                );
                
                 if (distToCrate < INTERACT_RANGE_HELP) {
                    ctx.fillText("–¢–∏—Å–Ω–∏ –î–Ü–Æ (–ü—Ä–æ–¥–∞—Ç–∏)", player.x + player.size / 2 + 5, player.y);
                } else if (distToStand < INTERACT_RANGE_HELP) {
                    ctx.fillText("–¢–∏—Å–Ω–∏ –î–Ü–Æ (–ö—É–ø–∏—Ç–∏)", player.x + player.size / 2 + 5, player.y);
                } else if (player.y > shopInterior.exitY - player.size) {
                     ctx.fillText("–ô–¥–∏ –≤–Ω–∏–∑ –¥–ª—è –í–∏—Ö–æ–¥—É", player.x - 70, player.y - 40);
                }
            } else if (currentScene === 'home') {
                 const distToBed = Math.sqrt(
                    Math.pow(player.x - homeInterior.bed.x, 2) + 
                    Math.pow(player.y - homeInterior.bed.y, 2)
                );
                if (distToBed < INTERACT_RANGE_HELP * 2) {
                    ctx.fillText("–¢–∏—Å–Ω–∏ –î–Ü–Æ (–°–ø–∞—Ç–∏)", player.x + player.size / 2 + 5, player.y);
                } else if (player.y > homeInterior.exitY - player.size) {
                     ctx.fillText("–ô–¥–∏ –≤–Ω–∏–∑ –¥–ª—è –í–∏—Ö–æ–¥—É", player.x - 70, player.y - 40);
                }
            }
        }
    }

    // –ì–æ–ª–æ–≤–Ω–∏–π —Ü–∏–∫–ª –≥—Ä–∏
    function gameLoop(currentTime) {
        if (!gameReady) {
            requestAnimationFrame(gameLoop);
            return;
        }

        const deltaTime = currentTime - time.lastTime;
        time.lastTime = currentTime;

        // –í–ò–ü–†–ê–í–õ–ï–ù–ù–Ø: –ü–µ—Ä–µ–¥–∞—î–º–æ –¥–µ–ª—å—Ç—É —á–∞—Å—É –≤ —Å–µ–∫—É–Ω–¥–∞—Ö, —Ç—ñ–ª—å–∫–∏ —è–∫—â–æ –≤–æ–Ω–∞ –Ω–µ –Ω—É–ª—å (–ø–µ—Ä—à–∏–π –∫–∞–¥—Ä)
        const deltaTimeSeconds = deltaTime > 0 ? deltaTime / 1000 : 0; 
        update(deltaTimeSeconds); 
        draw();
        requestAnimationFrame(gameLoop);
    }

    // –†–µ—Å–∞–π–∑ –≤—ñ–∫–Ω–∞
    window.addEventListener('resize', () => {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        updateZoneDimensions(); 
    });
    
    // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è —Ç–∞ –∑–∞–ø—É—Å–∫
    updateZoneDimensions(); 
    // –Ø–∫—â–æ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç—å—Å—è, –≥—Ä–∞ –∑–∞–ø—É—Å—Ç–∏—Ç—å—Å—è –ø—ñ—Å–ª—è playerImage.onerror/onload
    if (playerImageLoaded) { 
        gameLoop(0);
    }
</script>
</body>
</html>